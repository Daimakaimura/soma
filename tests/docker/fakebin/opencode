#!/usr/bin/env bash
set -euo pipefail

if [ "${1:-}" != "run" ]; then
    echo "fake opencode only supports 'opencode run'" >&2
    exit 2
fi

prompt="${!#:-}"
if [ -z "$prompt" ]; then
    echo "missing prompt" >&2
    exit 2
fi

soma_dir="$(printf '%s\n' "$prompt" | sed -n 's/^SOMA_DIR: //p' | head -n 1)"
today="$(printf '%s\n' "$prompt" | sed -n 's/^DATE: //p' | head -n 1)"
time_now="$(printf '%s\n' "$prompt" | sed -n 's/^TIME: //p' | head -n 1)"

if [ -z "$soma_dir" ]; then
    echo "SOMA_DIR not found in prompt" >&2
    exit 2
fi

if [ -z "$today" ]; then
    today="$(date -u +%Y-%m-%d)"
fi

if [ -z "$time_now" ]; then
    time_now="$(date -u +%H:%M:%S)"
fi

mkdir -p "${soma_dir}/memory/journal" "${soma_dir}/run" "${soma_dir}/lib"
journal_file="${soma_dir}/memory/journal/${today}.md"

append_journal() {
    local line="$1"
    {
        printf '\n### %s\n\n' "$time_now"
        printf '%s\n' "$line"
    } >> "$journal_file"
}

mode="generic"
if printf '%s\n' "$prompt" | grep -q "just been born"; then
    mode="birth"
elif printf '%s\n' "$prompt" | grep -q "routine interoception cycle"; then
    mode="cycle"
elif printf '%s\n' "$prompt" | grep -q "Someone is asking you a question"; then
    mode="query"
elif printf '%s\n' "$prompt" | grep -q "independent auditor"; then
    mode="audit"
fi

case "$mode" in
    birth)
        cat > "${soma_dir}/memory/self.md" <<EOF
I am a test instance created by the Docker smoke harness.
I report a stable baseline and use a deterministic fake agent for CI.
EOF
        cat > "${soma_dir}/memory/lessons.md" <<EOF
# Lessons

- Keep cycle, query, and audit write paths healthy.
EOF
        cat > "${soma_dir}/lib/sense.sh" <<'EOF'
#!/usr/bin/env bash
set -euo pipefail
printf 'host_name: %s\n' "$(hostname)"
printf 'kernel: %s\n' "$(uname -r)"
printf 'uptime_seconds: %s\n' "$(cut -d. -f1 /proc/uptime 2>/dev/null || echo unknown)"
EOF
        chmod +x "${soma_dir}/lib/sense.sh"
        append_journal "Birth completed by fake test agent."
        printf 'birth-ok\n'
        ;;
    cycle)
        append_journal "Cycle completed by fake test agent."
        printf 'cycle-ok\n'
        ;;
    query)
        append_journal "Query answered by fake test agent."
        printf 'fake response: systems nominal\n'
        ;;
    audit)
        cat > "${soma_dir}/run/audit-${today}.md" <<EOF
Audit status: sane.
Generated by fake test agent.
EOF
        append_journal "Audit completed by fake test agent."
        printf 'audit-ok\n'
        ;;
    *)
        printf 'ok\n'
        ;;
esac
